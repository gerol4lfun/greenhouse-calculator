#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ EXIF –¥–∞–Ω–Ω—ã—Ö
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç sips –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ EXIF –¥–∞–Ω–Ω—ã—Ö

echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
echo ""

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
temp_list=$(mktemp)
find image/products -type f \( -name "*.jpg" -o -name "*.png" \) > "$temp_list"

total=$(wc -l < "$temp_list" | tr -d ' ')
fixed=0

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
# sips -O –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ EXIF –¥–∞–Ω–Ω—ã—Ö –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
while IFS= read -r file; do
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    orientation_before=$(sips -g orientation "$file" 2>/dev/null | grep "orientation:" | awk '{print $2}')
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ—Ä—Ä–µ–∫—Ü–∏—é (–ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥)
    sips -O "$file" > /dev/null 2>&1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    orientation_after=$(sips -g orientation "$file" 2>/dev/null | grep "orientation:" | awk '{print $2}')
    
    # –ï—Å–ª–∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –±—ã–ª–∞ –Ω–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏
    if [ "$orientation_before" != "0" ] && [ "$orientation_before" != "<nil>" ] && [ -n "$orientation_before" ]; then
        echo "  ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: $file (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –±—ã–ª–∞: $orientation_before)"
        fixed=$((fixed + 1))
    fi
done < "$temp_list"

rm -f "$temp_list"

echo ""
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "   –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: $total –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
echo "   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: $fixed –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã."
echo ""
echo "üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: sips -O –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ"
echo "   EXIF –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏, —á—Ç–æ–±—ã"
echo "   –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–∞—Ö."