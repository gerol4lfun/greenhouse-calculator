# üìö –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π - –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

### –ó–∞–¥–∞—á–∞ 1: –†–∞–∑–Ω–µ—Å–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω `kb/greenhouse_kb.v1.json` - JSON –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
- ‚úÖ –°–æ–∑–¥–∞–Ω `db/migrations/20260203_create_knowledge_base.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ JSON

### –ó–∞–¥–∞—á–∞ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ —Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–∞ ‚úÖ
- ‚úÖ –£–±—Ä–∞–Ω `DROP TABLE` –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π dev-—Å–∫—Ä–∏–ø—Ç `db/migrations/dev_drop_knowledge_base.sql`
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `CREATE TABLE IF NOT EXISTS` –∏ `CREATE INDEX IF NOT EXISTS`

### –ó–∞–¥–∞—á–∞ 3: –ò–º–ø–æ—Ä—Ç—ë—Ä ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω `scripts/import_kb.js` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç: id/type/audience/title/text/source_ref
- ‚úÖ –î–µ–ª–∞–µ—Ç upsert –ø–æ id
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç: inserted/updated/skipped(deprecated)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –≤ `package.json`: `npm run kb:import`

### –ó–∞–¥–∞—á–∞ 4: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ ‚úÖ
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getKnowledgeBase()` –≤ `scripts/getKnowledgeBase.js`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ SQL —Ñ—É–Ω–∫—Ü–∏—è `get_knowledge_base()` –≤ `db/migrations/20260203_create_knowledge_base_search_function.sql`
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: q, tags, type, audience, includeDeprecated (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:
```sql
-- –§–∞–π–ª: db/migrations/20260203_create_knowledge_base.sql
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:
```sql
-- –§–∞–π–ª: db/migrations/20260203_create_knowledge_base_search_function.sql
```

### 3. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
npm install

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ
npm run kb:import
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –§–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å `SUPABASE_SERVICE_ROLE_KEY`
- –¢–∞–±–ª–∏—Ü–∞ `knowledge_base` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞

---

## üìñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

### –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:
```bash
npm run kb:import
```

### –ü–æ–∏—Å–∫ (—á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç):
```bash
npm run kb:search
```

### –ü–æ–∏—Å–∫ (—á–µ—Ä–µ–∑ SQL):
```sql
-- –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É
SELECT * FROM get_knowledge_base('–æ–ø–ª–∞—Ç–∞');

-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
SELECT * FROM get_knowledge_base(NULL, ARRAY['–æ–ø–ª–∞—Ç–∞', '—É—Å–ª–æ–≤–∏—è']);

-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫
SELECT * FROM get_knowledge_base('–¥–æ—Å—Ç–∞–≤–∫–∞', ARRAY['–¥–æ—Å—Ç–∞–≤–∫–∞'], 'FACT', 'internal_only', false);
```

### –ü–æ–∏—Å–∫ (—á–µ—Ä–µ–∑ JavaScript):
```javascript
const { getKnowledgeBase } = require('./scripts/getKnowledgeBase');

const results = await getKnowledgeBase({ 
    q: '–æ–ø–ª–∞—Ç–∞',
    tags: ['–æ–ø–ª–∞—Ç–∞'],
    type: 'FACT',
    audience: 'client_safe',
    includeDeprecated: false
});
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:

```
delivery-calculator-test-main/
‚îú‚îÄ‚îÄ kb/
‚îÇ   ‚îî‚îÄ‚îÄ greenhouse_kb.v1.json          # JSON –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ       ‚îú‚îÄ‚îÄ 20260203_create_knowledge_base.sql              # –û—Å–Ω–æ–≤–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ 20260203_create_knowledge_base_search_function.sql  # –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ dev_drop_knowledge_base.sql                     # DEV-ONLY: —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
‚îÇ       ‚îî‚îÄ‚îÄ README.md                                       # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ import_kb.js                    # –ò–º–ø–æ—Ä—Ç—ë—Ä —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ getKnowledgeBase.js             # –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ (JS)
‚îÇ   ‚îî‚îÄ‚îÄ README.md                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
‚îî‚îÄ‚îÄ package.json                         # –ö–æ–º–∞–Ω–¥—ã: kb:import, kb:search
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ:

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è production** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS`
2. **DEV-—Å–∫—Ä–∏–ø—Ç** (`dev_drop_knowledge_base.sql`) - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏!
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
4. **Deprecated –∫–∞—Ä—Ç–æ—á–∫–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ

---

**–ì–æ—Ç–æ–≤–æ! –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**
