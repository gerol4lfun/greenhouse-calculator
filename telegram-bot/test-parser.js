#!/usr/bin/env node
/**
 * –õ–æ–∫–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç –ø–∞—Ä—Å–µ—Ä–∞ –¥–∞—Ç (–±–µ–∑ Telegram –∏ Supabase)
 * –ó–∞–ø—É—Å–∫: node test-parser.js
 */

const { parseDeliveryDates } = require('./parser');

const TEST_INPUT = `–ú–æ—Å–∫–≤–∞ —Å 03.03
–ü–∏—Ç–µ—Ä —Å 02.03
–í–æ—Ä–æ–Ω–µ–∂ —Å 05.03, –∫—Ä–æ–º–µ 06.03, 07.03
–ö–∞–∑–∞–Ω—å —Å 04.03
–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä –¥–æ—Å—Ç–∞–≤–∫–∏ —Å 01.03, —Å–±–æ—Ä–∫–∏ —Å 02.03 (–∫—Ä–æ–º–µ 03.03, 04.03, 10.03)
–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Å 28.02, —Å–±–æ—Ä–∫–∏ —Å 01.03 (–∫—Ä–æ–º–µ 02.03, 03.03)
–ù–∞–±–µ—Ä–µ–∂–Ω—ã–µ —á–µ–ª–Ω—ã —Å 06.03
–í–µ–ª–∏–∫–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ —Å 02.03
–û—Ä—ë–ª —Å 05.03
–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥ —Å 02.03
–ß–µ—Ä–∫–µ—Å—Å–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ —Å 01.03, —Å–±–æ—Ä–∫–∏ —Å 02.03 (–∫—Ä–æ–º–µ 03.03, 04.03)`;

console.log('üß™ –¢–µ—Å—Ç –ø–∞—Ä—Å–µ—Ä–∞ –¥–∞—Ç –¥–æ—Å—Ç–∞–≤–∫–∏\n');
console.log('–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:');
console.log('‚îÄ'.repeat(50));
TEST_INPUT.split('\n').forEach((line, i) => console.log(`  ${i + 1}. ${line}`));
console.log('‚îÄ'.repeat(50));

const results = parseDeliveryDates(TEST_INPUT);

console.log('\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞:');
console.log('‚îÄ'.repeat(80));
let ok = 0;
let fail = 0;
results.forEach((item, i) => {
  const cityOk = !item.city.includes('–¥–æ—Å—Ç–∞–≤–∫–∏') ? '‚úì' : '‚úó –ì–û–†–û–î –° "–¥–æ—Å—Ç–∞–≤–∫–∏"!';
  const asmOk = (item.assembly_date && item.city.match(/–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä|—Å—Ç–∞–≤—Ä–æ–ø–æ–ª—å|–º–∞–π–∫–æ–ø|—á–µ—Ä–∫–µ—Å—Å–∫/i)) 
    ? (item.assembly_date ? '‚úì' : '‚úó –Ω–µ—Ç assembly') 
    : '';
  console.log(`  ${i + 1}. ${item.city} | –¥–æ—Å—Ç–∞–≤–∫–∞: ${item.date} | —Å–±–æ—Ä–∫–∞: ${item.assembly_date || '‚Äî'} | –∫—Ä–æ–º–µ: ${item.restrictions || '‚Äî'} ${cityOk}`);
  if (!item.city.includes('–¥–æ—Å—Ç–∞–≤–∫–∏')) ok++; else fail++;
});
console.log('‚îÄ'.repeat(80));
console.log(`\n–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${results.length} —Å—Ç—Ä–æ–∫`);
if (fail > 0) {
  console.log(`\n‚ùå –û–®–ò–ë–ö–ê: ${fail} –≥–æ—Ä–æ–¥–æ–≤ —Å–æ–¥–µ—Ä–∂–∞—Ç "–¥–æ—Å—Ç–∞–≤–∫–∏" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏`);
  process.exit(1);
}
console.log('\n‚úì –í—Å–µ –≥–æ—Ä–æ–¥–∞ –±–µ–∑ "–¥–æ—Å—Ç–∞–≤–∫–∏" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏');
console.log('‚úì –ü–∞—Ä—Å–µ—Ä –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é');
